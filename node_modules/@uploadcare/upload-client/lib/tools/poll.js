"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.poll = void 0;
var errors_1 = require("./errors");
var DEFAULT_INTERVAL = 500;
var poll = function (_a) {
    var check = _a.check, _b = _a.interval, interval = _b === void 0 ? DEFAULT_INTERVAL : _b, cancel = _a.cancel;
    return new Promise(function (resolve, reject) {
        var timeoutId;
        if (cancel) {
            cancel.onCancel(function () {
                timeoutId && clearTimeout(timeoutId);
                reject(errors_1.cancelError('Poll cancelled'));
            });
        }
        var tick = function () {
            try {
                Promise.resolve(check(cancel))
                    .then(function (result) {
                    if (result) {
                        resolve(result);
                    }
                    else {
                        timeoutId = setTimeout(tick, interval);
                    }
                })
                    .catch(function (error) { return reject(error); });
            }
            catch (error) {
                reject(error);
            }
        };
        timeoutId = setTimeout(tick, 0);
    });
};
exports.poll = poll;
